# We have a web server container running the nginx image. The access and error logs generated by the web server are not critical enough to be placed on a persistent volume. However, Nautilus developers need access to the last 24 hours of logs so that they can trace issues and bugs. Therefore, we need to ship the access and error logs for the web server to a log-aggregation service. Following the separation of concerns principle, we implement the Sidecar pattern by deploying a second container that ships the error and access logs from nginx. Nginx does one thing, and it does it well—serving web pages. The second container also specializes in its task—shipping logs. Since containers are running on the same Pod, we can use a shared emptyDir volume to read and write logs.


Create a pod named webserver.

Create an emptyDir volume shared-logs.

Create two containers from nginx and ubuntu images with latest tag only and remember to mention tag i.e nginx:latest, nginx container name should be nginx-container and ubuntu container name should be sidecar-container on webserver pod.

Add command on sidecar-container "sh","-c","while true; do cat /var/log/nginx/access.log /var/log/nginx/error.log; sleep 30; done"

Mount the volume shared-logs on both containers at location /var/log/nginx, all containers should be up and running.



Certainly! You can use a YAML file to define the Kubernetes Pod and containers. Save the following YAML content in a file, for example, `webserver-pod.yaml`:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webserver
spec:
  volumes:
  - name: shared-logs
    emptyDir: {}

  containers:
  - name: nginx-container
    image: nginx:latest
    volumeMounts:
    - name: shared-logs
      mountPath: /var/log/nginx

  - name: sidecar-container
    image: ubuntu:latest
    command: ["sh", "-c", "while true; do cat /var/log/nginx/access.log /var/log/nginx/error.log; sleep 30; done"]
    volumeMounts:
    - name: shared-logs
      mountPath: /var/log/nginx
```

To create the Pod, apply this YAML file using the `kubectl apply` command:

```bash
kubectl apply -f webserver-pod.yaml
```

This YAML file defines a Pod named `webserver` with an `emptyDir` volume named `shared-logs`. Two containers (`nginx-container` and `sidecar-container`) are created from the `nginx:latest` and `ubuntu:latest` images, respectively. The `sidecar-container` runs a command to continuously cat the contents of Nginx logs.

Both containers mount the `shared-logs` volume at the path `/var/log/nginx`. This ensures that both containers can share and access logs stored in that directory.

```ruby
thor@jump_host ~$ cat > webserver-pod.yaml
apiVersion: v1
kind: Pod
metadata:
  name: webserver
spec:
  volumes:
  - name: shared-logs
    emptyDir: {}

  containers:
  - name: nginx-container
    image: nginx:latest
    volumeMounts:
    - name: shared-logs
      mountPath: /var/log/nginx

  - name: sidecar-container
    image: ubuntu:latest
    command: ["sh", "-c", "while true; do cat /var/log/nginx/access.log /var/log/nginx/error.log; sleep 30; done"]
    volumeMounts:
    - name: shared-logs
      mountPath: /var/log/nginx
thor@jump_host ~$ kubectl apply -f webserver-pod.yaml
pod/webserver created
thor@jump_host ~$ 
thor@jump_host ~$ 
thor@jump_host ~$ kubectl get pod
NAME        READY   STATUS              RESTARTS   AGE
webserver   0/2     ContainerCreating   0          10s
thor@jump_host ~$ kubectl get pod
NAME        READY   STATUS    RESTARTS   AGE
webserver   2/2     Running   0          24s
thor@jump_host ~$ 
thor@jump_host ~$ 
thor@jump_host ~$ 
```


Certainly! Let's break down the YAML configuration for creating a Kubernetes Pod with two containers and a shared volume:

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: webserver
```

- `apiVersion`: Specifies the API version of the Kubernetes object. In this case, it's using the core/v1 version, which is the basic version for most Kubernetes objects.

- `kind`: Specifies the kind of Kubernetes object. Here, it's a Pod.

- `metadata`: Contains metadata about the Pod, including its name.

```yaml
spec:
  volumes:
  - name: shared-logs
    emptyDir: {}
```

- `spec`: Describes the specification of the Pod, including its containers and volumes.

- `volumes`: Defines a list of volumes that can be mounted by containers in the Pod.

  - `name: shared-logs`: Specifies the name of the volume as "shared-logs".

  - `emptyDir: {}`: Creates an emptyDir volume, which is a temporary storage volume that is shared among containers in the same Pod. It starts empty, and any data written to the volume is lost when the Pod is removed.

```yaml
  containers:
  - name: nginx-container
    image: nginx:latest
    volumeMounts:
    - name: shared-logs
      mountPath: /var/log/nginx
```

- `containers`: Specifies a list of containers to run in the Pod.

  - `name: nginx-container`: Names the first container as "nginx-container".

  - `image: nginx:latest`: Specifies the Docker image to use for the container. In this case, it's the latest version of the Nginx image.

  - `volumeMounts`: Defines a list of volume mounts for the container.

    - `name: shared-logs`: Matches the name of the volume declared earlier.

    - `mountPath: /var/log/nginx`: Mounts the shared volume at the path "/var/log/nginx" within the container.

```yaml
  - name: sidecar-container
    image: ubuntu:latest
    command: ["sh", "-c", "while true; do cat /var/log/nginx/access.log /var/log/nginx/error.log; sleep 30; done"]
    volumeMounts:
    - name: shared-logs
      mountPath: /var/log/nginx
```

- Another container definition, similar to the first one.

  - `name: sidecar-container`: Names the second container as "sidecar-container".

  - `image: ubuntu:latest`: Specifies the Docker image to use for the second container, which is the latest version of the Ubuntu image.

  - `command`: Overrides the default command for the container. It runs a shell command that continuously concatenates the contents of Nginx access and error logs with a sleep interval of 30 seconds.

  - `volumeMounts`: Similar to the first container, it defines a volume mount for the shared volume.

    - `name: shared-logs`: Matches the name of the shared volume.

    - `mountPath: /var/log/nginx`: Mounts the shared volume at the same path "/var/log/nginx" within the second container.

In summary, this YAML configuration creates a Pod named "webserver" with two containers ("nginx-container" and "sidecar-container") that share an emptyDir volume named "shared-logs" mounted at "/var/log/nginx" in both containers. The second container continuously concatenates Nginx logs in the specified path.
